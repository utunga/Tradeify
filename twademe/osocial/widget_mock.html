<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Widget</title>
</head>
<body>
    <div style="width: 737px; padding: 5px">
        <!-- copy to tradeify_widget.xml starts below here -->
        <link href="../osocial/tradeify_widget.css" rel="stylesheet" type="text/css" media="all" />
        <link href="../css/ooooby_theme/jquery.autocomplete.css" rel="stylesheet" type="text/css"
            media="all" />
        <link href="../css/ooooby_theme/jquery-ui-1.7.2.custom.css" rel="stylesheet" type="text/css"
            media="all" />
        <link href="../css/ooooby_theme/Pager.css" rel="stylesheet" type="text/css" media="all" />
        <!--<input type="text" class="ui-state-default ui-corner-all" name="searchdata" id="searchdata"/>
<button class="ui-button ui-state-default ui-corner-all" onclick="queryServer()">search</button>-->
        <div id="current_tags">
            <br />
        </div>
        <div id="results">
            <ul>
                <li><a href="#results-1">List</a></li>
                <li><a href="#results-2">Map</a></li>
                <li><a href="#results-3">Post your own</a></li>
            </ul>
            <div class="left_col">
                <div id="results-1">
                    <span class="template" id="offer_template">
                        <div class="offer" style="padding-bottom: 20px;">
                            <a href="#" class="offer_overall"><span><a href="user_uri" class="avatar" target="_top">
                                <img src="user_thumb" width="16" height="16" alt="username" /></a> <a href="user_uri"
                                    target="_top" class="username"></a>
                                <p class="msg">
                                    <span class="text"></span>
                                    <br />
                                    <span class="tags"><span class="tag"><a href="#" onclick=""></a>, </span></span>
                                </p>
                                <div class="meta">
                                    <a class="when" href="source_uri">Today, 10:50 am</a>
                                </div>
                            </span></a>
                        </div>
                    </span>
                    <div id="pager">
                    </div>
                </div>
                <div id="results-2">
                    <div id="offer_map">
                    </div>
                </div>
                <div id="results-3">
                    <div id="post_your_own_form">
                        <div class="tooltip">
                        </div>
                        <fieldset id="by_parts" class="ui-corner-all">
                            <h4>
                                <input type="radio" name="message_type" value="OFFER" onclick="update_offer()"/>I am offering<input type="radio"
                                    name="message_type" value="WANT" onclick="update_offer()"/>
                                I want</h4>
                            <div id="post_your_own_general_tags">
                            </div>
                            <div id="type_tag_div style="margin-bottom:15px">
                            <input type="text" class="ui-state-default ui-corner-all" id="typed_tag"/>
                            <button class="ui-button ui-state-default ui-corner-all" id="add_typed_tag">add</button>
                            </div>
                            <div class="offerPart">
                                <textarea tabindex="0" cols="42" rows="3" type="text" name="offer" class="ui-state-default ui-corner-all defaultText"
                                    id="offer" title="(details)"></textarea>
                            </div>
                            <div class="location">
                                <label for="location">
                                    in
                                </label>
                                <input type="text" class="ui-state-default ui-corner-all defaultText" tabindex="1" name="location"
                                    id="location" title="(suburb)" />
                                <div id="map_canvas">
                                </div>
                                <!--map goes here -->
                                <div class="infobox">
                                </div>
                            </div>
                            <div class="currency">
                                <label for="for" class="desc">
                                    for
                                </label>
                                <div id="post_your_own_currency_tags">
                                </div>
                            </div>
                            <div class="until">
                                <label for="until" class="desc">
                                    until
                                </label>
                                <input type="text" name="until" id="until" class="ui-state-default ui-corner-all" />
                            </div>
                            <!-- <div class="tags" style="width: 430px;">
                    <label> Tags </label>
                    <ul id="selected_tags">
                        <li><a href="#" class="tag"></a></li>
                    </ul>
                    <blockquote>
                        <h4>Suggested Tags (click to select)</h4> 
                        <div id="suggested_tags">
                            <span class="template">
                                <ul class="select_tag_container">
                                    <li><a href="#" class="tag"></a></li>
                                </ul>
                            </span>
                        </div>
                        <h4>Or type to add more</h4> 
                        <input id="tags" name="tags" onkeyup="timeoutKeyChange()" class="ui-state-default ui-corner-all" tabindex="8" maxlength="255" style="width: 360px;"/>
                    </blockquote>
                
                </div>-->
                            <!--       <div class="thumbnail">
                    <label for="picture_thumbnail"> Link to picture? </label>
                    <input type="text" tabindex="8" maxlength="255" class="ui-state-default ui-corner-all" name="picture" id="picture" >
                </div>-->
                        </fieldset>
                        <div class="rawMessage">
                            <fieldset>
                                <!--<legend>Your offer</legend>	-->
                                <textarea title="" cols="42" rows="6" onkeyup="message_keyup()" name="message" class="ui-state-default ui-corner-all "
                                    id="message_to_send" title="(Details)"></textarea>
                                <button class="send_message ui-button ui-state-default ui-corner-all">
                                    Post</button>
                                <a class="message_details"><a class="location_detail status"><a>Location</a> </a><a
                                    class="currency_detail status"><a>Type of Trade</a> </a><a class="group_detail status">
                                        <a>Ooooby tag</a> </a></a>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right_col">
                <h3>
                    Find</h3>
                <div id="type_filter" style="font-size:150%">
                    <a id="offered_filter" class="tag type_filter fg-button ui-state-active" onclick="toggle_offered()">Offered
                    </a> |
                    <a id="wanted_filter" class="tag type_filter fg-button ui-state-active" onclick="toggle_wanted()">Wanted
                    </a>
                </div>
                <h4>
                    Categories/Tags</h4>
                <div id="filter_general_tags">
                </div>
                <!-- <input type="text" class="ui-state-default ui-corner-all" id="search_general_tag"/>
        <button class="ui-button ui-state-default ui-corner-all" onclick="queryGeneralTag()">search</button>
       -->
                <h4>
                    Type of trade</h4>
                <div id="filter_currency_tags">
                </div>
                <h4>
                    Location</h4>
                <div id="filter_location_tags">
                </div>
                <input type="text" class="ui-state-default ui-corner-all" id="search_location_tag" />
                <button class="ui-button ui-state-default ui-corner-all" onclick="queryLocationTag()">
                    search</button>
            </div>
        </div>
        <div id="map_popup" style="padding-bottom: 30px;">
            <span class="template">
                <div class="map_offer" style="padding-bottom: 20px;">
                    <a href="#" class="map_offer_overall"><span><a href="user_uri" class="map_avatar"
                        target="_top">
                        <img src="map_user_thumb" width="16" height="16" alt="username" /></a> <a href="map_user_uri"
                            target="_top" class="map_username"></a>
                        <p class="map_msg">
                            <span class="map_text"></span>
                            <br />
                            <span class="map_tags"><span class="map_tag"><a href="#" onclick=""></a>, </span>
                            </span>
                        </p>
                        <div class="meta">
                            <a class="map_when" href="source_uri">Today, 10:50 am</a>
                        </div>
                    </span></a>
                </div>
            </span>
        </div>
        <!--[if lt IE 7]>
<script src="http://ie7-js.googlecode.com/svn/version/2.0(beta3)/IE7.js" type="text/javascript"></script>
<![endif]-->
        <!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>-->

        <script type="text/javascript" src="../js/jquery-1.3.2.js">      </script>

        <!--OOOOBY.NING.ORG GOOGLE API KEY = ABQIAAAABEpdHyPr3QztCREcH5edthQJninID-M6PHkd65PL9JwO4W5uJxR_4_SFIiW5EiCw9BgVYD7J-NQ32w -->
        <!-- google maps API v3 doesn't need an API key! -->

        <script type="text/javascript" src="http://www.google.com/jsapi"></script>

        <script type="text/javascript" src="../js/jquery-ui-1.7.2.custom.min.js"></script>

        <script type="text/javascript" src="../js/quickpager.jquery.js"></script>

        <script type="text/javascript" src="../js/jquery.pager.js"></script>

        <script type="text/javascript" src="../js/jquery.autocomplete.min.js"></script>

        <!--
<script type="text/javascript" src="../js/jquery.tools.min.js"></script>
-->

        <script type="text/javascript" src="../js/pure_packed_v2.js"></script>

        <script type="text/javascript" src="../js/tag_support.js"></script>

        <script type="text/javascript" src="../osocial/tradeify_widget.js"></script>

        <!--<script type="text/javascript" src="../osocial/opensocial_wrapper.js"></script>-->
        <!--uncomment for running on ning as part of tradiefy_widget.xml-->

        <script type="text/javascript" src="../osocial/mock_wrapper.js"></script>

        <!--             un comment for running as part of widget_mock.html-->

        <script type="text/javascript" src="../osocial/widget_support.js"></script>

<script type="text/javascript">

    var post_your_own_general_tags;
    //var message_type;
    var post_your_own_currency_tags;
    var currency_tagset = new Array("free", "barter", "cash");
    var general_tagset = new Array("veges", "fruit", "eggs", "honey", "nuts", "grains", "seeds"
, "seedlings", "garden_supplies", "garden_services", "books", "workshops");

    var filter_general_tags;
    var filter_currency_tags;
    var filter_location_tags;

    //var current_tags;
    var list_widget;
    var map_widget;

    //RHS Tags 
    var createRHSTags = function() {

        var general_tags = new Array();
        var currency_tags = new Array();
        var location_tags = new Array();
        $.each(list_widget.get_tags(), function() {
            switch (this.type) {
                case "tag":
                    general_tags.push(this.tag);
                    break;
                case "currency":
                    currency_tags.push(this.tag);
                    break;
                case "loc":
                    location_tags.push(this.tag);
                    break;
            }
        });

        var update_filter = function(tag_text, tag_type) { list_widget.toggle_filter(tag_text, tag_type); }
        filter_general_tags = new TagsWidget("#filter_general_tags", general_tags, list_widget.current_tags, "tag", update_filter);
        filter_currency_tags = new TagsWidget("#filter_currency_tags", currency_tags, list_widget.current_tags, "currency", update_filter);
        filter_location_tags = new TagsWidget("#filter_location_tags", location_tags, list_widget.current_tags, "loc", update_filter);
    }

    function default_tag_setup() {
        $(".defaultText").focus(function(srcc) {
            if ($(this).val() == $(this)[0].title) {
                $(this).removeClass("defaultTextActive");
                $(this).val("");
            }
        });

        $(".defaultText").blur(function() {
            if ($(this).val() == "") {
                $(this).addClass("defaultTextActive");
                $(this).val($(this)[0].title);
            }
        });

        $(".defaultText").blur();      

    }


    $(document).ready(function() {

        // adjusts height in ning, does nothing in test
        container.adjustHeight(1000);
        $("#search_location_tag").autocomplete(container.tags_ahead_uri + "?type=loc");
        $("#typed_tag").autocomplete(container.tags_ahead_uri + "?type=tag");

        list_widget = new TradeifyWidget("#results-1", "#current_tags");
        list_widget.add_fixed_filter("ooooby", "group");
        map_widget = new MapWidget("offer_map", "#map_popup", list_widget);

        $("#add_typed_tag").click(function() {
            var typed_tag_text = $("#typed_tag").val();
            post_your_own_general_tags.Tags.add_tag(typed_tag_text, "tag", true);
            tags_widget_click();
        });

        list_widget.on_offers_updated(createRHSTags);

        $("#results").tabs({
            fx: { height: 'toggle', opacity: 'toggle' },
            show: function(event, ui) {
                if (ui.panel.id == "results-2") {
                    $(ui.panel).css("height", "100%");
                    map_widget.update_map(); //need to create the google map *after* tab shown
                }
                if (ui.panel.id == "results-3") {
                    $(".right_col").hide();
                    post_your_own_form_init(); //need to create the google map for the form *after* tab shown
                }
                else $(".right_col").show();
            }
        });

        $("#by_parts input").keyup(update_offer);
        $("#by_parts textarea").keyup(update_offer);
        $("#by_parts input").change(update_offer);
        default_tag_setup();
        post_your_own_currency_tags = new TagsWidget("#post_your_own_currency_tags", currency_tagset, list_widget.current_tags, "type", update_offer);
        post_your_own_general_tags = new SuggestedTagsWidget("#post_your_own_general_tags", general_tagset, [], "tag", tags_widget_click);

        $("#post_your_own_form #until").datepicker({
            minDate: 0,
            dateFormat: "dd M yy",
            constrainInput: true,
            showOn: "focus"
        });

        $(".send_message").click(function() {
            var message = $("#message_to_send").val();
            container.post_message(message, function(response_data) {
                console.log("post_message result:" + response_data);
                alert("message posted");
                list_widget.update_offers();
            });

            // how long to wait after submit for the form to load?
            setTimeout(list_widget.update_offers, 300);

            // reset / clear the form
            // scrolIntoView the top tab
            // set tab to list view
            // check that filters wont hide the message
        });

        $("#post_your_own_form form").submit(function(e) {

            // FIXME: this looks a heck of a lot like a no-op to me
            var input = $(".rawMessage #message_to_send", this).val();
            $("#message_to_send").val(input);

            // do not submit the form
            return e.preventDefault();
        });

        //parse offer just in case there is infromation already there
        parse_offer();

    });  //end document.ready


</script>

        <!-- end copy to tradeify_widget.xml -->
    </div>
</body>
</html>
