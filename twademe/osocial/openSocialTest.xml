<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="Tradeify" 
    height="600" scrolling="true"> 
    <Require feature="dynamic-height"/>
<Require feature="opensocial-0.7" />
  </ModulePrefs>
  <!-- Content section for profile view omitted -->
  <Content type="html" view="canvas">
    <![CDATA[
  <style>
.offer {
border:1px solid #616351;
float:left;
font-size:16px;
margin-top:10px;
padding:12px;
width:100%;
}.offer .date {
float:left;
font-family:Georgia,"Times New Roman",Times,serif;
font-size:11px;
font-weight:bold;
padding-bottom:5px;
}a:hover {
color:#000000;
text-decoration:underline;
}
a, a:link, a:visited {
color:#616351;
text-decoration:none;
}.offer .msg {
-moz-background-clip:border;
-moz-background-inline-policy:continuous;
-moz-background-origin:padding;
background:#EBF2C9 none repeat scroll 0 0;
padding:50px;
}a:hover {
color:#000000;
text-decoration:underline;
}
a, a:link, a:visited {
color:#616351;
text-decoration:none;
}.offer .msg .text {
font-family:Georgia,"Times New Roman",Times,serif;
font-size:16px;
}a:hover {
color:#000000;
text-decoration:underline;
}
a, a:link, a:visited {
color:#616351;
text-decoration:none;
}.offer .msg .more_info_link {
float:right;
font-size:12px;
padding:4px 0;
}
a:hover {
color:#000000;
text-decoration:underline;
}
a, a:link, a:visited {
color:#616351;
text-decoration:none;
}
</style>
      <script type="text/os-template">  
      </script>
     
      
	  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script> 
	 <script src="http://tradeify.org/joav/jquery-ui-1.7.2.custom.min.js" type="text/javascript"></script> 
	<script type="text/javascript" src="http://tradeify.org/js/purePacked.js"></script>

	       
		<form id="search">
		<input type='text' name='searchdata'>
		<a href="javascript: queryServer()">Search</a>
		<a href="javascript: resetQuery()">Reset</a>
		</form>
        <div id="results_by_date">
         <span class="template">
   
	        <div class="offer">
                <div class="offer_left">
                    <div class="date"></div><!-- /date -->
                    <div class="user">
                        <a href="#">
                        	<img alt="" src="#" width="50" height="50"/>
                            <h4></h4>
                        </a>                                                                                                        
                    </div>

                    
                </div><!-- /offer-left -->
                <div class="offer_right">                                                                                                                                                                           
                    <div class="msg">                                                                                                                                               
                        <div class="text">offer text<!-- minus tags at end? -->

                        </div>                        
                        <div class="tags">
                            <span class="tag"><a class="" href="#">#</a>, </span>
                        </div><!-- /tags -->
                        <!-- float right, align baseline, if possible have preview -->
                        <a class="more_info_link" href="">more info »</a>
                        <!-- <a class="thumb" href="">thumb »</a>-->
                        <a href="#">

                        	<img alt="" src="#" />
                            <h4></h4>
                        </a> 
                    </div><!-- /msg -->
                 </div><!-- /offer_right -->
            
            </div><!--/offer -->
               
            </span> <!-- template -->   
        </div><!--- /RESULTS- ------>
      	<div id="main" class="regular">
<div class="gutter">
<h4>What are you offering?</h4>
<!--<textarea class="part_of_message" cols="40" rows="2" name="RawMessage" accesskey="u"/>-->
<form id="myform">
Message: <input type='text' name='message'>
<a href="javascript: sendData()">Submit</a>
<button id="create-user" class="ui-button ui-state-default ui-corner-all">Create new user</button></form>
</div>
</div>  
   
	  <script type="text/javascript">
 var offersJson=-1; 
var selected_tags=new Array(); 
function compile_render_functions() {
        // most complicated is rendering to offers div
        var offers = jQuery('#results_by_date  .template').mapDirective({
            'div.offer': 'offer <- messages',
            '.date': 'offer.date',
            '.user a[href]': 'offer.user.more_info_url',
            // '.msg a.thumb[href]': '#{offer.thumbnail_url}',
            '.msg img[src]': 'offer.thumbnail_url',
            '.user img[src]': 'offer.user.profile_pic_url',
            '.user h4': 'offer.user.screen_name',
            '.msg .text': 'offer.offer_text',
            '.msg a.more_info_link[href]': '#{offer.more_info_url}'
        });
    
        var tagsList = jQuery('div.tags', offers).mapDirective({
            '.tag': 'tag <- offer.tags',
            'a[href]': 'tag.tag',
            'a+': 'tag.tag'
        });

        jQuery('div.tags', offers).html(tagsList); //place sub-template tagsList into offers template
        $p.compile(offers, 'offers_render_fn'); //compile to a function
        update();
		gadgets.window.adjustHeight(5000);
        /// -- end offers function
    }
              
    function update_offers(json_url) {
        jQuery.getJSON(json_url, function(context) {
            //alert("context:" + context);
			offersJson=context;
            jQuery('#results_by_date').html($p.render('offers_render_fn', context));
        });
			
	}

    function update() {
        update_offers("http://tradeify.org/offers_json.aspx?jsoncallback=?");
    }

function onGetData(data) {
	var message=document.forms["myform"].message.value;
	alert("in my form "+message);
//prompt("Enter your message","Enter you message","");
	var viewer = data.get('viewer').getData();
	var viewerJson= gadgets.json.stringify(viewer);
	var name = viewer.getDisplayName();
	var thumbnail= viewer.getField(opensocial.Person.Field.THUMBNAIL_URL,null);
	alert("display name: "+ name);  

	//REMOVE LATER
	var dataPacket = {};
	dataPacket.Message = message;
	dataPacket.User = viewer;
	var dataPacketJSON = gadgets.json.stringify(dataPacket);
	
	var mes = {
		RawMessage:message,
		UserName:name,
		Thumbnail:thumbnail,
		DataPacket:dataPacketJSON
	};
	makeRequest("http://tradeify.org/accept_post.aspx",mes);
} 

function sendData(){
	var req = opensocial.newDataRequest();
	req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), 'viewer');
	req.send(onGetData);
}
function search(){
	alert("start searching");
	var tag=document.forms["search"].searchdata.value;
	alert("searching for "+tag);	
	var newMessages=new Array();
	var arrayCount=0;
	alert("itterating through messages");
	for(var i=0;i<offersJson.messages.length;i++){
		var msg=offersJson.messages[i];
		//alert("message "+msg.offer_text);
		for(var j=0;j<msg.tags.length;j++){
			if(msg.tags[j].tag==tag){				
				alert("found tag "+msg.tags[j].tag);
				newMessages[arrayCount]=msg;
				arrayCount++;
			}
		}
	}
	offersJson=newMessages;
	alert("found "+newMessages.length);
	jQuery('#results_by_date').html($p.render('offers_render_fn', newMessages));
	} 	
	
function reset(){
	selected_tags=new Array();
	update();
	}	
function queryServer(){
	var query=document.forms["search"].searchdata.value;
	var queryIdx=jQuery.inArray(query,selected_tags);
	if(queryIdx!=-1){	
	return;
	}
/*	
	else{
        var tmp = []; 
        jQuery.each(selected_tags, function() {
            if (this != query) {
                tmp.push(this);
            }
        });
        selected_tags = tmp;

	}
	*/
	selected_tags.push(query);
	var url=build_search_query("http://tradeify.org/offers_json.aspx");
	update_offers(url);	
	
	
}
 function build_search_query(baseUrl) {
	var query="";
		for(tag in selected_tags){
			if(query!="")query=query+"&";
			query=query+"tag="+selected_tags[tag];
			}
        return baseUrl + "?" + query+"&jsoncallback=?";
    }
	
function makeRequest(url, postdata) {
	var params = {};
	postdata = gadgets.io.encodeValues(postdata);
	params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
	params[gadgets.io.RequestParameters.POST_DATA]= postdata;
	var response=-1;
	gadgets.io.makeRequest(url,response , params);
}

	compile_render_functions();
	//openForm();
	//sendData(); 
 
      </script>
	  
<style type="text/css">
		body { font-size: 62.5%; }
		label, input { display:block; }
		input.text { margin-bottom:12px; width:95%; padding: .4em; }
		fieldset { padding:0; border:0; margin-top:25px; }
		h1 { font-size: 1.2em; margin: .6em 0; }
		div#users-contain {  width: 350px; margin: 20px 0; }
		div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
		div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
		.ui-button { outline: 0; margin:0; padding: .4em 1em .5em; text-decoration:none;  !important; cursor:pointer; position: relative; text-align: center; }
		.ui-dialog .ui-state-highlight, .ui-dialog .ui-state-error { padding: .3em;  }
		
		
	</style>
	
	<script type="text/javascript">
		/*
		var name = jQuery("#name"),
			email = jQuery("#email"),
			password = jQuery("#password"),
			allFields = jQuery([]).add(name).add(email).add(password),
			tips = jQuery("#validateTips");

		function updateTips(t) {
			tips.text(t).effect("highlight",{},3000);
		}*/
		
/*
		function checkLength(o,n,min,max) {

			if ( o.val().length > max || o.val().length < min ) {
				o.addClass('ui-state-error');
				updateTips("Length of " + n + " must be between "+min+" and "+max+".");
				return false;
			} else {
				return true;
			}

		}

		function checkRegexp(o,regexp,n) {

			if ( !( regexp.test( o.val() ) ) ) {
				o.addClass('ui-state-error');
				updateTips(n);
				return false;
			} else {
				return true;
			}

		}
*/		
		jQuery("#dialog").dialog({
			bgiframe: true,
			autoOpen: false,
			height: 1500,
			modal: true,
			buttons: {
				'Create an account': function() {
					var bValid = true;
					allFields.removeClass('ui-state-error');
					/*
					bValid = bValid && checkLength(name,"username",3,16);
					bValid = bValid && checkLength(email,"email",6,80);
					bValid = bValid && checkLength(password,"password",5,16);

					bValid = bValid && checkRegexp(name,/^[a-z]([0-9a-z_])+$/i,"Username may consist of a-z, 0-9, underscores, begin with a letter.");
					// From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
					bValid = bValid && checkRegexp(email,/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,"eg. ui@jquery.com");
					bValid = bValid && checkRegexp(password,/^([0-9a-zA-Z])+$/,"Password field only allow : a-z 0-9");
					
					if (bValid) {
						$('#users tbody').append('<tr>' +
							'<td>' + name.val() + '</td>' + 
							'<td>' + email.val() + '</td>' + 
							'<td>' + password.val() + '</td>' +
							'</tr>'); 
						$(this).dialog('close');
					}
					*/
				},
				Cancel: function() {
					jQuery(this).dialog('close');
				}
			},
			close: function() {
				allFields.val('').removeClass('ui-state-error');
			}
		
		
		
		jQuery('#create-user').click(function() {
			jQuery('#dialog').dialog('open');
		})
		.hover(
			function(){ 
				jQuery(this).addClass("ui-state-hover"); 
			},
			function(){ 
				jQuery(this).removeClass("ui-state-hover"); 
			}
		).mousedown(function(){
			jQuery(this).addClass("ui-state-active"); 
		})
		.mouseup(function(){
				jQuery(this).removeClass("ui-state-active");
		});

	});
	</script>



<div class="demo">

<div id="dialog" title="Create new user">
	<form>
	<fieldset> <ul>
            <li>
                <label class="desc" id="title2" for="message">
                </label>
                <div>
                    <textarea id="message" name="message" class="field textarea small" rows="10" cols="50"
                        tabindex="1"></textarea>
                </div>
            </li>
			
			 <li>
                <label class="desc" for="offer">
                    I am offering <span id="req_3" class="req">*</span>
                </label>
                <div>
                    <textarea onkeyup="updateOffer()" id="offer" name="offer" type="text" rows="5" cols="50"></textarea>
                </div>
            </li>
			
            <li class="location">
                <label class="desc" for="location">
                    In <span id="req_6" class="req">* L:</span>
                </label>
                <div>
                    <input id="location" onkeyup="updateOffer()" name="location" type="text" class="field text medium"
                        maxlength="255" tabindex="3" />
                    <div id="map_canvas">
                        </div>
                        <div class="infobox">
                        </div>
                        <div class="example">
                            e.g. "in L:Wellington, NZ" (click to change)</div>
                    </div>
            </li>
			
            <li>
                <label class="desc" for="for">
                    For <span id="req_209" class="req">*</span>
                </label>
                <div>
                    <select id="for" name="for" class="field select medium" tabindex="4">
                        <option value="#free">#free </option>
                        <option value="#barter">#barter </option>
                    </select>
                </div>
            </li>
			
		
            <li id="li_date">
                <label class="desc" for="until">
                    Until
                </label>
				<div>
                <input id="until" name="until" type="text"></input>
                </div> </li>
        
		<!--
        <hr style="width: 500px; height: 1px; color: Black; display: block; text-align: left;" />
        
		<ul>
		-->
            <li>
                <label class="desc" id="title212" for="Field212">
                    Link to picture
                </label>
                <img src="" />
                <input id="Field212" type="text" class="field text medium" value="" maxlength="255"
                    tabindex="8" />
            </li>   
			
    <!--<form action="goes_nowhere">-->
    
        <li>
            <label class="desc" id="Label1" for="Field212">          
                Tags:
            </label>
            <input id="tags" class="field text medium" value="" onkeyup="timeoutKeyChange()" maxlength="255"
                tabindex="8" />
        </li>
        <li>Current tags:
           <ul id="selected_tags">
                <li><a href="#" class="tag"></a></li>
            </ul>            
        </li>
        <li>
          Suggested Tags:          
          <div id="suggested_tags">
                <span class="template">
                    <ul class="select_tag_container">
                        <li><a href="#" class="tag"></a></li>
                    </ul>
                </span>
          </div>
          
    </li>
    
	                   </ul>					   <style>
        span.on
        {
            background: #CCC;
        }
		</style>
        <script type="text/javascript">
            jQuery(function() {
                jQuery("#until").datepicker();
            });


            function MessagePart(type, field) {
                this.prefix = type;
                this.field = field;
            }

            var offerPrefix = " I am offering ";
            var locationPrefix = " in L:";
            var locationSuffix = ": ";
            var forPrefix = " for ";
            var untilPrefix = " until ";
            var linkPrefix = "here is a link to an image: ";
            function getUntil() {
                if (jQuery("#until").val().length == 0) {
                    return "";
                }
                else {
                    return untilPrefix + jQuery("#until").val();
                }
            }

            function updateOffer() {
                var concatMessage =
                         offerPrefix +
                         jQuery("#offer").val() +
                         locationPrefix + jQuery("#location").val() + locationSuffix +
                         forPrefix + jQuery("#for").val() +
                         getUntil();
                jQuery("#message").val(concatMessage);
            }
            var selected_tags = [];
            var tags = [];

            function onClick() {
                var tagField = jQuery("#tags").val();
                var pushed_tag = jQuery(this).html();
                if (jQuery.inArray(pushed_tag, selected_tags) <= -1) {
                    if (tagField != "")
                        jQuery("#tags").val(tagField + " " + pushed_tag);
                    else jQuery("#tags").val(pushed_tag);
                }
                else {
                    //var txt = new RegExp("(,\s*" + pushed_tag + "\s*)|(^\s*" + pushed_tag + "\s*,*)");
                    var replacementText = tagField.replace(pushed_tag, "");
                    jQuery("#tags").val(replacementText);
                }
                updateTags();
            }

            function getTagString() {
                var tagString = "";
                jQuery.each(selected_tags, function() {
                    tagString = tagString + " #" + this;
                });
                return tagString;
            }

            function checkCSS() {
                jQuery.each(jQuery(".select_tag"), function() {
                    if (jQuery.inArray(jQuery(this).html(), selected_tags) > -1) {
                        jQuery(this).addClass("on");
                    }
                    else if (jQuery(this).hasClass("on")) jQuery(this).removeClass("on");
                });
            }

            var threshold = 200;
            var keyChangeStack = 0;
            function timeoutKeyChange() {
                keyChangeStack++;
                setTimeout(function() {
                    keyChangeStack--;
                    if (keyChangeStack == 0) {
                        updateTags();
                    }
                }, threshold);
            }

            function updateTags() {

                //get rid of multiple spaces...
                var txt = new RegExp("\\s\\s+");
                jQuery("#tags").val(jQuery("#tags").val().replace(txt, " "));
                //just in case a single \t or \n is present
                txt = new RegExp("\\s+");
                jQuery("#tags").val(jQuery("#tags").val().replace(txt, " "));

                selected_tags = jQuery("#tags").val().split(" ");

                var selectedTagsHTML = jQuery(selected_tags).map(function() {
                    return "#" + this;
                }).get().join(", ");


                jQuery("#selected_tags").html(selectedTagsHTML);

                var json_url = build_search_query_tags("http://tradeify.org/tags_json.aspx");
                jQuery.getJSON(json_url, function(context) {
                    tags = context.tags_json.overall;
                    var tagString = "";
                    jQuery.each(tags, function() {
                        var on = "";
                        var endon = "";
                        if ((jQuery.inArray(this.tag, selected_tags) > -1)) {
                            on = "<li class=\"on\">";
                            endon = "</li>";
                        }
                        else {
                            on = "<li>";
                            endon = "</li>";
                        }
                        tagString = (tags === "") ? this.tag : tagString + "\n" + on + "<a href=\"#\" class=\"select_tag\">" + this.tag + "</a>" + endon;
                    });

                    //alert(tagString);
                    //if (!(typeof suggested_tags_render_fn == 'function')) {
                    //if not yet compiled compile it
                    /*    compile_render_fn();
                
                var render = $p.render('suggested_tags_render_fn', tags);
                    */
                    jQuery('#suggested_tags').html(tagString);
                    jQuery("#suggested_tags .select_tag").click(onClick);
                });


                //checkCSS();
                //alert(getTagString());
            }

            //        function compile_render_fn() {

            //            var selected_tags = jQuery('#suggested_tags .template').mapDirective({
            //                '.select_tag_container': 'tag <- overall',
            //                '.select_tag_container .tag': 'tag.tag'
            //            });
            //            $p.compile(selected_tags, 'suggested_tags_render_fn'); //compile to a function
            //        }

            function build_search_query_tags(baseUrl) {
                var query = "";
                jQuery.each(tags, function() {
                    if (jQuery.inArray(this.tag, selected_tags) > -1)
                        query = query + this.type + "=" + escape(this.tag) + "&";
                });
                query = query.substring(0, query.length - 1);
                return baseUrl + "?" + query +"&jsoncallback=?";
            }
            
        </script>

	
<!--
                <li id="li_MoreInfo" class="     ">
                    <label class="desc" id="lab_MoreInfo" for="More info:">
                        More info:
                    </label>
                    <input id="More info:" name="More info:" type="text" class="field text medium" value=""
                        maxlength="255" tabindex="8" />
                </li>
                <li class="buttons ">
                    <input id="saveForm" name="saveForm" class="btTxt submit" type="submit" value="Submit" />
                </li>
		
		<label for="name">Name</label>
		<input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all" />
		<label for="email">Email</label>
		<input type="text" name="email" id="email" value="" class="text ui-widget-content ui-corner-all" />
		<label for="password">Password</label>
		<input type="password" name="password" id="password" value="" class="text ui-widget-content ui-corner-all" />
-->
	</fieldset>
	</form>
</div>

    ]]>
  </Content>
</Module>
