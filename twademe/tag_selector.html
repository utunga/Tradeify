<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        span.on {
            background:#CCC;
        }
    </style>    

</head>
<body>
    <h1>
        test of tag selector</h1>
    <form action="goes_nowhere">
    <ul>
        <li>
            <label class="desc" id="Label1" for="Field212">
               <span class="on">
                Tags:
            </label>
            <input id="tags" class="field text medium" value="" onchange="updateTags()" maxlength="255"
                tabindex="8" />
        </li>
        <li>Recommended tags:
           <h2 id="selected_tags">
                <span class="template">   
                <span class="select_tag_container"> <a href="#" class="select_tag">offers</a></span>
                </span>
            </h2>
            
<!--            <ul class="tag_list">
                <li><a href="#" class="tag">food</a></li>
                <li class="on"><a href="#" class="tag">lodging</a></li>
                <li><a href="#" class="tag"><b>beer</b></a></li>
            </ul>-->
            
 <!--           <div id="suggested_tags">
                <span class="template">
                    <ul class="tag_list">
                        <li><a href="#" class="tag"></a></li>
                    </ul>
                </span>
            </div>-->
            
            <div class="recommended_tags" name="recommended_tags" id="recommended_tags">
                None</div>
        </li>
    </ul>
    </form>


    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
    <script type="text/javascript" src="js/purePacked.js"></script>
    <script type="text/javascript">
        var selected_tags = [];
        var tags = "";
        //compile_render_fn();
        function clickable() {
            $(".select_tag").click(function() {
            var pushed_tag = $(this).html();
            if ($.inArray(pushed_tag, selected_tags) <= -1) {
                $("#tags").val($("#tags").val() +","+ pushed_tag);
                    updateTags();
                }
            });
        }
        function checkCSS() {
            $.each($(".select_tag"), function() {
            if ($.inArray($(this).html(), selected_tags) > -1) {
                    $(this).addClass("on");
                }
            else if ($(this).hasClass("on"))$(this).removeClass("on");
            });
        }
        function updateTags() {
            selected_tags = $("#tags").val().split(",");
            $.each(selected_tags, function() {
                this.trim();
            });
            
            var json_url = build_search_query("/tags_json.aspx");
            $.getJSON(json_url, function(context) {
                var recommended_tags = context.tags_json.overall;
                tags = context.tags_json;
                var tagString = "";
                $.each(recommended_tags, function() {
                    var on = ($.inArray(this.tag, selected_tags) > -1) ? "<span class=\"on\">" : "";
                    var endon = ($.inArray(this.tag, selected_tags) > -1) ? "</span>" : "";
                    tagString = (tags === "") ? this.tag : tagString + "\n" + on + "<a href=\"#\" class=\"select_tag\">" + this.tag + "</a>" + endon; //" , " + this.tag;
                });
                //alert(tagString);
                //if (!(typeof selected_tags_render_fn == 'function')) {
                //if not yet compiled compile it
                /*    compile_render_fn();
                
                var render = $p.render('selected_tags_render_fn', tags);
                */
                $('#selected_tags').html(tagString);

                clickable();
            });
            checkCSS();
            $('#selected_tags').html(('#selected_tags').html());
        }
        
        function compile_render_fn() {

            var selected_tags = $('#selected_tags .template').mapDirective({
                'span.select_tag_container': 'tag <- overall',
                '.select_tag_container .select_tag': 'tag.tag'
            });

            $p.compile(selected_tags, 'selected_tags_render_fn'); //compile to a function
            
        }

        function build_search_query(baseUrl) {
            var query = $(selected_tags).map(function() {
                return this.type + "=" + escape(this.tag);
            }).get().join("&");
            return baseUrl + "?" + query;
        }
        //alert($('#suggested_tags .template'));
        /*var avail_tags = $('#suggested_tags .template').mapDirective({
        // 'div.tag_list': 'tags <- messages',
        'div.tag_list': 'tags.tag'
        });*/
        /*var selected_tags = $('#selected_tags .template').mapDirective({
        'tag_list': 'tags <- overall',
        'tag_list .tag': 'tags.tag'
        });*/
        //$('#suggested_tags .template').autoRender(tags);
        /*
        'input[value]': 'tag.tag',
        'input[name]': 'tag.type',
        'em[style]': function(arg) {
        return "width:" + arg.item.pct + "px";
        },
        'input[onclick]': "'toggle_select(this);'",
        'input[checked]': function(arg) {
        if (is_selected(arg.item.type, arg.item.tag)) { return "checked" }
        else return "";
        }
        //'a[onclick]': "'toggle_select(" + arg.item.tag + "," +  arg.item.tag + ");'"
        });*/
    </script>

</body>
</html>
