<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        li.on {
            background:#CCC;
        }
        #suggested_tags li,
        #selected_tags li
        {
        	display:inline;
        }
    </style>    

</head>
<body>
    <h1>
        test of tag selector, THIS PAGE HAS BEEN UPDATED</h1>
    <form action="goes_nowhere">
    <ul>
        <li>
            <label class="desc" id="Label1" for="Field212">          
                Tags:
            </label>
            <input id="tags" class="field text medium" value="" onkeyup="timeoutKeyChange()" maxlength="255"
                tabindex="8" />
        </li>
        <li>Current tags:
           <ul id="selected_tags">
                <li><a href="#" class="tag"></a></li>
            </ul>            
        </li>
        <li>
          Suggested Tags:          
          <div id="suggested_tags">
                <span class="template">
                    <ul class="select_tag_container">
                        <li><a href="#" class="tag"></a></li>
                    </ul>
                </span>
          </div>
          
    </li>
    </ul>
    </form>
<span class="on">

    <script type="text/javascript" src="/js/jquery-1.3.2.js"></script>
    <script type="text/javascript" src="/js/purePacked.js"></script>
    <script type="text/javascript">
        var selected_tags = [];
        var tags = [];
        
        function onClick() {
            var tagField = $("#tags").val();
            var pushed_tag = $(this).html();
            if ($.inArray(pushed_tag, selected_tags) <= -1) {
                if (tagField != "")
                    $("#tags").val(tagField + " " + pushed_tag);
                else $("#tags").val(pushed_tag);
            }
            else {
                //var txt = new RegExp("(,\s*" + pushed_tag + "\s*)|(^\s*" + pushed_tag + "\s*,*)");
                var replacementText = tagField.replace(pushed_tag, "");
                $("#tags").val(replacementText);
            }
            updateTags();
        }
        
        function getTagString() {
            var tagString=""
            $.each(selected_tags, function() {
                tagString = tagString + " #" + this;
            });
            return tagString;
        }
        
        function checkCSS() {
            $.each($(".select_tag"), function() {
            if ($.inArray($(this).html(), selected_tags) > -1) {
                    $(this).addClass("on");
                }
            else if ($(this).hasClass("on"))$(this).removeClass("on");
            });
        }
        
        var threshold = 200;
        var keyChangeStack=0;
        function timeoutKeyChange() {
            keyChangeStack++;
            setTimeout(function() {
                keyChangeStack--;
                if (keyChangeStack == 0) {
                    updateTags();
                }
            }, threshold);
        }
        
        function updateTags() {
        
            //get rid of multiple spaces...
            var txt = new RegExp("\\s\\s+");
            $("#tags").val($("#tags").val().replace(txt, " "));
            //just in case a single \t or \n is present
            txt = new RegExp("\\s+");
            $("#tags").val($("#tags").val().replace(txt, " "));
             
            selected_tags = $("#tags").val().split(" ");
            
            var selectedTagsHTML = $(selected_tags).map(function() {
                return "#" + this;
            }).get().join(", ");

           
            $("#selected_tags").html(selectedTagsHTML);
            
            var json_url = build_search_query("/tags_json.aspx");
            $.getJSON(json_url, function(context) {
                tags = context.tags_json.overall;
                var tagString = "";
                $.each(tags, function() {
                    var on = "";
                    var endon = "";
                    if (($.inArray(this.tag, selected_tags) > -1)) {
                        on = "<li class=\"on\">";
                        endon = "</li>";
                    }
                    else {
                        on = "<li>";
                        endon = "</li>";
                    }
                    tagString = (tags === "") ? this.tag : tagString + "\n" + on + "<a href=\"#\" class=\"select_tag\">" + this.tag + "</a>" + endon;
                });  
                
                //alert(tagString);
                //if (!(typeof suggested_tags_render_fn == 'function')) {
                //if not yet compiled compile it
                /*    compile_render_fn();
                
                var render = $p.render('suggested_tags_render_fn', tags);
                */
                $('#suggested_tags').html(tagString);
                $("#suggested_tags .select_tag").click(onClick);
            });
            
                
            //checkCSS();
            //alert(getTagString());
        }
        
//        function compile_render_fn() {

//            var selected_tags = $('#suggested_tags .template').mapDirective({
//                '.select_tag_container': 'tag <- overall',
//                '.select_tag_container .tag': 'tag.tag'
//            });
//            $p.compile(selected_tags, 'suggested_tags_render_fn'); //compile to a function
//        }

        function build_search_query(baseUrl) {
            if (tags.length == 0) return baseUrl;
            var query = "";
            $.each(tags, function() {
                if($.inArray(this.tag,selected_tags)>-1)
                    query = query + this.type + "=" + escape(this.tag) + "&";
            });
            query = query.substring(0, query.length - 1);
            return baseUrl + "?" + query;
        }
        
        //alert($('#suggested_tags .template'));
        /*var avail_tags = $('#suggested_tags .template').mapDirective({
        // 'div.tag_list': 'tags <- messages',
        'div.tag_list': 'tags.tag'
        });*/
        /*var selected_tags = $('#selected_tags .template').mapDirective({
        'tag_list': 'tags <- overall',
        'tag_list .tag': 'tags.tag'
        });*/
        //$('#suggested_tags .template').autoRender(tags);
        /*
        'input[value]': 'tag.tag',
        'input[name]': 'tag.type',
        'em[style]': function(arg) {
        return "width:" + arg.item.pct + "px";
        },
        'input[onclick]': "'toggle_select(this);'",
        'input[checked]': function(arg) {
        if (is_selected(arg.item.type, arg.item.tag)) { return "checked" }
        else return "";
        }
        //'a[onclick]': "'toggle_select(" + arg.item.tag + "," +  arg.item.tag + ");'"
        });*/
    </script>

</body>
</html>
