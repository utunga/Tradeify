<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        span.on {
            background:#CCC;
        }
    </style>    

</head>
<body>
    <h1>
        test of tag selector</h1>
    <form action="goes_nowhere">
    <ul>
        <li>
            <label class="desc" id="Label1" for="Field212">
               
                Tags:
            </label>
            <input id="tags" class="field text medium" value="" onkeyup="timeoutKeyChange()" maxlength="255"
                tabindex="8" />
        </li>
        <li>Recommended tags:
           <h2 id="selected_tags">
                <span class="template">   
                <span class="select_tag_container"> <a href="#" class="select_tag">offers</a></span>
                </span>
            </h2>
            
<!--            <ul class="tag_list">
                <li><a href="#" class="tag">food</a></li>
                <li class="on"><a href="#" class="tag">lodging</a></li>
                <li><a href="#" class="tag"><b>beer</b></a></li>
            </ul>-->
            
 <!--           <div id="suggested_tags">
                <span class="template">
                    <ul class="tag_list">
                        <li><a href="#" class="tag"></a></li>
                    </ul>
                </span>
            </div>-->
            
            <div class="recommended_tags" name="recommended_tags" id="recommended_tags">
                None</div>
        </li>
    </ul>
    </form>
<span class="on">

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
    <script type="text/javascript" src="/js/purePacked.js"></script>
    <script type="text/javascript">
        var selected_tags = [];
        var tags = [];

        //compile_render_fn();
        function clickable() {           
            $(".select_tag").click(parseClick);
        }
        /*
        function parseClick() {
            var tagField = $("#tags").val();
            var pushed_tag = $(this).html();
            if ($.inArray(pushed_tag, selected_tags) <= -1) {
                if (tagField != "")
                    $("#tags").val(tagField + "," + pushed_tag);
                else $("#tags").val(pushed_tag);
            }
            else {
                var txt = new RegExp("(,\s*" + pushed_tag + "\s*)|(^\s*" + pushed_tag + "\s*,*)");
                var replacementText = tagField.replace(txt, "");
                $("#tags").val(replacementText);
            }
            updateTags();


        }
        */
        function parseClick() {
            var tagField = $("#tags").val();
            var pushed_tag = $(this).html();
            if ($.inArray(pushed_tag, selected_tags) <= -1) {
                if (tagField != "")
                    $("#tags").val(tagField + " " + pushed_tag);
                else $("#tags").val(pushed_tag);
            }
            else {
                //var txt = new RegExp("(,\s*" + pushed_tag + "\s*)|(^\s*" + pushed_tag + "\s*,*)");
                var replacementText = tagField.replace(pushed_tag, "");
                $("#tags").val(replacementText);
            }
            updateTags();

        }
        function getTagString() {
            var tagString=""
            $.each(selected_tags, function() {
                tagString = tagString + " #" + this;
            });
            return tagString;
        }
        
        function checkCSS() {
            $.each($(".select_tag"), function() {
            if ($.inArray($(this).html(), selected_tags) > -1) {
                    $(this).addClass("on");
                }
            else if ($(this).hasClass("on"))$(this).removeClass("on");
            });
        }
        
        var threshold = 1500;
        var keyChangeStack=0;
        function timeoutKeyChange() {
            keyChangeStack++;
            setTimeout(function() {
                keyChangeStack--;
                if (keyChangeStack == 0) {
                    updateTags();
                }
            }, threshold);
        }
        function updateTags() {
            //get rid of multiple spaces...
            var txt = new RegExp("\\s\\s+");
            $("#tags").val($("#tags").val().replace(txt, " "));
            //just in case a single \t or \n is present
            txt = new RegExp("\\s+");
            $("#tags").val($("#tags").val().replace(txt, " "));
             
            selected_tags = $("#tags").val().split(" ");
            
            var json_url = build_search_query("/tags_json.aspx");
            $.getJSON(json_url, function(context) {
                tags = context.tags_json.overall;
                var tagString = "";
                $.each(tags, function() {
                    var on = "";
                    var endon = "";
                    if (($.inArray(this.tag, selected_tags) > -1)) {
                        on = "<span class=\"on\">";
                        endon = "</span>";
                    }
                    tagString = (tags === "") ? this.tag : tagString + "\n" + on + "<a href=\"#\" class=\"select_tag\">" + this.tag + "</a>" + endon;
                });
                //alert(tagString);
                //if (!(typeof selected_tags_render_fn == 'function')) {
                //if not yet compiled compile it
                /*    compile_render_fn();
                
                var render = $p.render('selected_tags_render_fn', tags);
                */
                $('#selected_tags').html(tagString);
                clickable();
            });
            //checkCSS();
            alert(getTagString());
        }
        
        function compile_render_fn() {

            var selected_tags = $('#selected_tags .template').mapDirective({
                'span.select_tag_container': 'tag <- overall',
                '.select_tag_container .select_tag': 'tag.tag'
            });

            $p.compile(selected_tags, 'selected_tags_render_fn'); //compile to a function
            
        }

        function build_search_query(baseUrl) {
            if (tags.length == 0) return baseUrl;
            var query = "";
            $.each(tags, function() {
                if($.inArray(this.tag,selected_tags)>-1)
                    query = query + this.type + "=" + escape(this.tag) + "&";
            });
            query = query.substring(0, query.length - 1);
            return baseUrl + "?" + query;
        }
        //alert($('#suggested_tags .template'));
        /*var avail_tags = $('#suggested_tags .template').mapDirective({
        // 'div.tag_list': 'tags <- messages',
        'div.tag_list': 'tags.tag'
        });*/
        /*var selected_tags = $('#selected_tags .template').mapDirective({
        'tag_list': 'tags <- overall',
        'tag_list .tag': 'tags.tag'
        });*/
        //$('#suggested_tags .template').autoRender(tags);
        /*
        'input[value]': 'tag.tag',
        'input[name]': 'tag.type',
        'em[style]': function(arg) {
        return "width:" + arg.item.pct + "px";
        },
        'input[onclick]': "'toggle_select(this);'",
        'input[checked]': function(arg) {
        if (is_selected(arg.item.type, arg.item.tag)) { return "checked" }
        else return "";
        }
        //'a[onclick]': "'toggle_select(" + arg.item.tag + "," +  arg.item.tag + ");'"
        });*/
    </script>

</body>
</html>
